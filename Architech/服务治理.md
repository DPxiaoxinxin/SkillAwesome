# 服务治理

[TOC]

## 服务发现

### 客户端服务发现模式

#### 概述

![](https://img-blog.csdn.net/20160419111801783)

* 客户端负责决定可用的服务实例的网络地址，以及围绕他们的负载均衡
* 客户端向服务注册表（service registry）发送一个请求，服务注册表是一个可用服务实例的数据库。
* 客户端使用一个负载均衡算法，去选择一个可用的服务实例，来响应这个请求
* 一个服务实例被启动时，它的网络地址会被写到注册表上；当服务实例终止时，再从注册表中删除。这个服务实例的注册表通过心跳机制动态刷新。

#### 示例

Netflix Eureka是一个服务注册表，提供了REST API用来管理服务实例的注册和查询可用的实例。Netflix Ribbon是一个IPC客户端，和Eureka一起处理可用服务实例的负载均衡。下面会深入讨论Eureka。

#### 优点

* 相对直接，除了服务注册表，没有其它动态的部分
* 由于客户端知道可用的服务实例，可以做到智能的，应用明确的负载均衡决策，比如一直用hash算法

#### 缺点

* 客户端和服务注册表是一一对应的，必须为服务客户端用到的每一种编程语言和框架实现客户端服务发现逻辑

### 服务端服务发现模式

#### 概述

![](https://img-blog.csdn.net/20160419111840399)

* 客户端通过负载均衡器向一个服务发送请求，这个负载均衡器会查询服务注册表，并将请求路由到可用的服务实例上
* 通过客户端的服务发现，服务实例在服务注册表上被注册和注销。

#### 示例

Consul Template定期从存储在Consul服务注册表的数据中，生成任意的配置文件。每当文件变化时，会运行一个shell命令。比如，Consul Template可以生成一个配置反向代理的nginx.conf文件，然后运行一个命令告诉Nginx去重新加载配置。

#### 优点

* 服务发现的细节被从客户端中抽象出来，客户端只需要向负载均衡器发送请求，不需要为服务客户端使用的每一种语言和框架，实现服务发现逻辑

#### 缺点

* 除非这个负载均衡器是由部署环境提供的，又是另一个高需要启动和管理的可用的系统组件。



### 服务注册表(Service Registry)

#### 概述

* 服务发现的关键部分，是一个包含了服务实例的网络地址的数据库，**必须是高可用和最新的**
* 由一个服务器集群组成，通过应用协议来保持一致性

#### 示例

* Netflix Eureka是一个服务注册表的好例子。它提供了一个REST API用来注册和查询服务实例。一个服务实例通过POST请求来注册自己的网络位置，每隔30秒要通过一个PUT请求重新注册。注册表中的一个条目会因为一个HTTP DELETE请求或实例注册超时而被删除，客户端通过一个HTTP GET请求来检索注册的服务实例
* **Etcd**：一个高可用，分布式，一致的key-value存储，用来共享配置和服务发现。Kubernetes和Cloudfoundry都使用了etcd；
* **Consul**：一个发现和配置服务的工具。客户端可以利用它提供的API，注册和发现服务。Consul可以执行监控检测来实现服务的高可用；
* **Apache Zookeeper**：一个常用的，为分布式应用设计的高可用协调服务，最开始Zookeeper是Hadoop的子项目，现在已经顶级项目了。

### 服务注册(Service Registration)

#### 自注册模式（The Self-Registration Pattern）

##### 概述

在self-registration模式中，服务实例负责从服务注册表中注册和注销。如果需要的话，一个服务实例发送心跳请求防止注册过期。

##### 示例

Eureka客户端处理服务实例注册和注销的所有问题。Spring Cloud实现包括服务发现在内的多种模式，简化了Eureka的服务实例自动注册。仅仅通过@EnableEurekaClient注释就可以注释Java的配置类

##### 优点

简单，不需要其它组件

##### 缺点

服务实例和服务注册表相对应，必须要为服务中用到的每种编程语言和框架实现注册代码。

#### 第三方注册模式（The Third-Party Registration Pattern）

##### 概述

在third-party registration模式中，服务实例不会自己在服务注册表中注册，由另一个系统组件service registrar负责。service registrar通过轮询部署环境或订阅事件去跟踪运行中的实例的变化。当它注意到一个新的可用的服务实例时，就会到注册表中去注册。service registrar也会将停止的服务实例注销

![](https://img-blog.csdn.net/20160419112117050)

##### 示例

开源的Registrator项目。它会自动注册和注销像Docker容器一样部署的服务。Registrator支持etcd和Consul等服务注册。

##### 优点

解耦了服务和服务注册表。不需要为每个语言和框架都实现服务注册逻辑。服务实例注册由一个专用的服务集中实现

##### 缺点

除了被内置到部署环境中，它本身也是一个高可用的系统组件，需要被启动和管理。



## 服务注册中心比较

| Feature              | Consul                 | zookeeper             | etcd              | euerka                       |
| -------------------- | ---------------------- | --------------------- | ----------------- | ---------------------------- |
| 服务健康检查         | 服务状态，内存，硬盘等 | (弱)长连接，keepalive | 连接心跳          | 可配支持                     |
| 多数据中心           | 支持                   | —                     | —                 | —                            |
| kv存储服务           | 支持                   | 支持                  | 支持              | —                            |
| 一致性               | raft                   | paxos                 | raft              | —                            |
| cap                  | cp                     | cp                    | cp                | ap                           |
| 使用接口(多语言能力) | 支持http和dns          | 客户端                | http/grpc         | http（sidecar）              |
| watch支持            | 全量/支持long polling  | 支持                  | 支持 long polling | 支持 long polling/大部分增量 |
| 自身监控             | metrics                | —                     | metrics           | metrics                      |
| 安全                 | acl /https             | acl                   | https支持（弱）   | —                            |
| spring cloud集成     | 已支持                 | 已支持                | 已支持            | 已支持                       |